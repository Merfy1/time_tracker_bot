2025-03-14 15:34:42,693 - INFO - –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!
2025-03-14 15:34:54,094 - INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Merfy (633566051) –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞.
2025-03-14 15:36:39,882 - INFO - Received signal 2 (SIGINT), stopping...
2025-03-14 15:37:26,255 - INFO - –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!
2025-03-14 15:37:36,838 - INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Merfy (633566051) –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞.
2025-03-14 15:37:47,427 - INFO - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: üîÅ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–µ –§–ò–û (–ö–æ–¥: CODE-5743)
2025-03-14 15:38:02,630 - INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å üîÅ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–µ –§–ò–û –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É (–ö–æ–¥: CODE-5743)
2025-03-14 15:39:57,289 - INFO - Received signal 2 (SIGINT), stopping...
2025-03-14 15:40:07,525 - INFO - –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!
2025-03-14 15:40:22,492 - INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Merfy (633566051) –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞.
2025-03-14 15:40:42,940 - INFO - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –°—Ç–æ—Ä–æ–∂–µ–Ω–∫–æ (–ö–æ–¥: CODE-2903)
2025-03-14 15:40:51,086 - INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –°—Ç–æ—Ä–æ–∂–µ–Ω–∫–æ –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É (–ö–æ–¥: CODE-2903)
2025-03-14 15:41:24,569 - INFO - Received signal 2 (SIGINT), stopping...
2025-03-14 15:41:32,693 - INFO - –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!
2025-03-14 15:41:47,853 - INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Merfy (633566051) –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞.
2025-03-14 15:42:06,629 - INFO - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ë—É—Ä–µ–Ω–∏–Ω –ü–∞–≤–µ–ª (–ö–æ–¥: CODE-4259)
2025-03-14 15:42:15,473 - INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë—É—Ä–µ–Ω–∏–Ω –ü–∞–≤–µ–ª –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É (–ö–æ–¥: CODE-4259)
2025-03-14 15:42:32,746 - INFO - Received signal 2 (SIGINT), stopping...
2025-03-14 15:42:45,775 - INFO - –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!
2025-03-14 15:42:52,160 - ERROR - –û—à–∏–±–∫–∞ —Å API —Å–æ–±–∞–∫: HTTPSConnectionPool(host='random.dg', port=443): Max retries exceeded with url: /woof.json (Caused by NameResolutionError("<urllib3.connection.HTTPSConnection object at 0x105f80160>: Failed to resolve 'random.dg' ([Errno 8] nodename nor servname provided, or not known)"))
2025-03-14 15:42:54,142 - INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë—É—Ä–µ–Ω–∏–Ω –ü–∞–≤–µ–ª –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É (–ö–æ–¥: CODE-4259)
2025-03-14 15:43:03,966 - INFO - Received signal 2 (SIGINT), stopping...
2025-05-09 18:37:24,729 - INFO - –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!
2025-05-09 18:38:29,113 - INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Merfy (633566051) –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞.
2025-05-09 18:38:38,854 - INFO - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –°–∞—à–∞ (–ö–æ–¥: CODE-5427)
2025-05-09 18:38:49,811 - WARNING - –ù–µ—É–¥–∞—á–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞ —Å –∫–æ–¥–æ–º: 5427
2025-05-09 18:39:07,867 - ERROR - –û—à–∏–±–∫–∞ —Å API —Å–æ–±–∞–∫: HTTPSConnectionPool(host='random.xn--dg-fmc', port=443): Max retries exceeded with url: /woof.json (Caused by NameResolutionError("<urllib3.connection.HTTPSConnection object at 0x1027b76a0>: Failed to resolve 'random.xn--dg-fmc' ([Errno 8] nodename nor servname provided, or not known)"))
2025-05-09 18:39:08,285 - INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –°–∞—à–∞ –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É (–ö–æ–¥: CODE-5427)
2025-05-09 18:55:39,495 - INFO - Received signal 2 (SIGINT), stopping...
2025-05-09 20:03:20,353 - INFO - –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!
2025-05-09 20:03:42,722 - INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Merfy (633566051) –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞.
2025-05-09 20:03:48,130 - INFO - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –°–∞—à–µ–Ω—å–∫–∞ (–ö–æ–¥: CODE-7466)
2025-05-09 20:04:04,027 - ERROR - –û—à–∏–±–∫–∞ —Å API —Å–æ–±–∞–∫: HTTPSConnectionPool(host='random.xn--dg-fmc', port=443): Max retries exceeded with url: /woof.json (Caused by NameResolutionError("<urllib3.connection.HTTPSConnection object at 0x11855a550>: Failed to resolve 'random.xn--dg-fmc' ([Errno 8] nodename nor servname provided, or not known)"))
2025-05-09 20:04:05,104 - INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –°–∞—à–µ–Ω—å–∫–∞ –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É (–ö–æ–¥: CODE-7466)
2025-05-09 20:04:14,216 - INFO - Received signal 2 (SIGINT), stopping...
2025-05-09 20:05:15,836 - INFO - –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!
2025-05-09 20:05:26,242 - INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Merfy (633566051) –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞.
2025-05-09 20:05:40,472 - INFO - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –°–∞—à–∫–∞ (–ö–æ–¥: CODE-5742)
2025-05-09 20:05:59,915 - ERROR - –û—à–∏–±–∫–∞ —Å API —Å–æ–±–∞–∫: HTTPSConnectionPool(host='random.xn--dg-fmc', port=443): Max retries exceeded with url: /woof.json (Caused by NameResolutionError("<urllib3.connection.HTTPSConnection object at 0x108527550>: Failed to resolve 'random.xn--dg-fmc' ([Errno 8] nodename nor servname provided, or not known)"))
2025-05-09 20:06:00,466 - INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –°–∞—à–∫–∞ –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É (–ö–æ–¥: CODE-5742)
2025-05-09 20:07:47,170 - INFO - Received signal 2 (SIGINT), stopping...
2025-05-09 20:07:53,620 - INFO - –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!
2025-05-09 20:08:01,488 - INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Merfy (633566051) –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞.
2025-05-09 20:08:23,162 - WARNING - –ù–µ—É–¥–∞—á–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞ —Å –∫–æ–¥–æ–º: import logging
import random
import requests
from telegram import Update, ReplyKeyboardMarkup, KeyboardButton
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext
from config import TELEGRAM_TOKEN
from database import create_connection

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(levelname)s - %(message)s',
    level=logging.INFO,
    filename='bot.log'
)
logger = logging.getLogger(__name__)

# –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
def get_random_image():
    dog_api = "https://random.dog/woof.json"
    cat_api = "https://api.thecatapi.com/v1/images/search"
    try:
        response = requests.get(dog_api, timeout=5)
        if response.status_code == 200:
            image_url = response.json().get("url")
            if image_url:
                return image_url
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å API —Å–æ–±–∞–∫: {e}")

    try:
        response = requests.get(cat_api, timeout=5)
        if response.status_code == 200:
            image_url = response.json()[0].get("url")
            if image_url:
                return image_url
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å API –∫–æ—Ç–æ–≤: {e}")

    return "https://placekitten.com/400/400"

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞
def work_keyboard():
    return ReplyKeyboardMarkup(
        [[KeyboardButton("‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å —Å–º–µ–Ω—É")], [KeyboardButton("‚èπ –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–º–µ–Ω—É")]],
        resize_keyboard=True
    )

# –°—Ç–∞—Ä—Ç
def start(update: Update, context: CallbackContext):
    user = update.message.from_user
    chat_id = update.message.chat_id
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.first_name} ({chat_id}) –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞.")

    buttons = [
        [KeyboardButton("‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è")],
        [KeyboardButton("üîë –í–æ–π—Ç–∏")],
    ]
    reply_markup = ReplyKeyboardMarkup(buttons, resize_keyboard=True, one_time_keyboard=True)

    update.message.reply_text(f"–ü—Ä–∏–≤–µ—Ç, {user.first_name}! –í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=reply_markup)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
def handle_message(update: Update, context: CallbackContext):
    user = update.message.from_user
    chat_id = update.message.chat_id
    text = update.message.text

    if text == "‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è":
        update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –§–ò–û –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:")
        context.user_data["is_registering"] = True
        return

    if context.user_data.get("is_registering"):
        full_name = update.message.text
        unique_code = f"CODE-{random.randint(1000, 9999)}"

        connection = create_connection()
        cursor = connection.cursor()

        try:
            cursor.execute("SELECT * FROM employees WHERE full_name = ?", (full_name,))
            result = cursor.fetchone()

            if result:
                update.message.reply_text(
                    "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –§–ò–û —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–≤–µ—Å—Ç–∏ –¥—Ä—É–≥–æ–µ –§–ò–û –∏–ª–∏ –≤–æ–π—Ç–∏."
                )
                update.message.reply_text("–ù–∞–∂–º–∏ ¬´–í–æ–π—Ç–∏¬ª, —á—Ç–æ–±—ã –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞.",
                    reply_markup=ReplyKeyboardMarkup([[KeyboardButton("üîë –í–æ–π—Ç–∏")]], resize_keyboard=True))
                return

            cursor.execute("INSERT INTO employees (full_name, unique_code) VALUES (?, ?)", (full_name, unique_code))
            connection.commit()

            update.message.reply_text(f"–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –¢–≤–æ–π –∫–æ–¥: {unique_code}")
            update.message.reply_text("–¢–µ–ø–µ—Ä—å –º–æ–∂–µ—à—å –≤–æ–π—Ç–∏:",
                reply_markup=ReplyKeyboardMarkup([[KeyboardButton("üîë –í–æ–π—Ç–∏")]], resize_keyboard=True))

            logger.info(f"–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {full_name} (–ö–æ–¥: {unique_code})")

            connection.close()
            context.user_data["is_registering"] = False
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {e}")
            update.message.reply_text("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.")
        return

    if text == "üîë –í–æ–π—Ç–∏":
        update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥:")
        context.user_data["is_logging_in"] = True
        return

    if context.user_data.get("is_logging_in"):
2025-05-09 20:08:45,819 - INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Merfy (633566051) –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞.
2025-05-09 20:08:52,824 - ERROR - –û—à–∏–±–∫–∞ —Å API —Å–æ–±–∞–∫: HTTPSConnectionPool(host='random.xn--dg-fmc', port=443): Max retries exceeded with url: /woof.json (Caused by NameResolutionError("<urllib3.connection.HTTPSConnection object at 0x109dfb550>: Failed to resolve 'random.xn--dg-fmc' ([Errno 8] nodename nor servname provided, or not known)"))
2025-05-09 20:08:53,932 - INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –°–∞—à–µ–Ω—å–∫–∞ –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É (–ö–æ–¥: CODE-7466)
2025-05-09 20:10:56,843 - INFO - Received signal 2 (SIGINT), stopping...
2025-05-09 20:12:20,535 - INFO - –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!
2025-05-09 20:12:25,673 - INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Merfy (633566051) –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞.
2025-05-09 20:12:35,772 - INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –°–∞—à–µ–Ω—å–∫–∞ –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É (–ö–æ–¥: CODE-7466)
2025-05-09 20:13:15,541 - INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Merfy (633566051) –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞.
2025-05-09 20:13:24,615 - INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –°–∞—à–µ–Ω—å–∫–∞ –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É (–ö–æ–¥: CODE-7466)
2025-05-09 20:20:49,765 - INFO - Received signal 2 (SIGINT), stopping...
2025-05-09 20:22:38,546 - INFO - –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!
2025-05-09 20:22:56,577 - INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Merfy (633566051) –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞.
2025-05-09 20:23:08,566 - ERROR - –û—à–∏–±–∫–∞ —Å API —Å–æ–±–∞–∫: HTTPSConnectionPool(host='random.xn--dg-fmc', port=443): Max retries exceeded with url: /woof.json (Caused by NameResolutionError("<urllib3.connection.HTTPSConnection object at 0x1079a23a0>: Failed to resolve 'random.xn--dg-fmc' ([Errno 8] nodename nor servname provided, or not known)"))
2025-05-09 20:23:09,390 - INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –°–∞—à–µ–Ω—å–∫–∞ –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É (–ö–æ–¥: CODE-7466)
2025-05-09 20:23:17,299 - ERROR - –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ —Å–º–µ–Ω—ã: local variable 'cursor' referenced before assignment
2025-05-09 20:23:19,822 - ERROR - –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ —Å–º–µ–Ω—ã: local variable 'cursor' referenced before assignment
2025-05-09 20:23:34,876 - INFO - Received signal 2 (SIGINT), stopping...
2025-05-09 20:24:54,322 - INFO - –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!
2025-05-09 20:25:06,625 - INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Merfy (633566051) –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞.
2025-05-09 20:25:15,032 - ERROR - –û—à–∏–±–∫–∞ —Å API —Å–æ–±–∞–∫: HTTPSConnectionPool(host='random.xn--dg-fmc', port=443): Max retries exceeded with url: /woof.json (Caused by NameResolutionError("<urllib3.connection.HTTPSConnection object at 0x1061be520>: Failed to resolve 'random.xn--dg-fmc' ([Errno 8] nodename nor servname provided, or not known)"))
2025-05-09 20:25:15,904 - INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –°–∞—à–µ–Ω—å–∫–∞ –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É (–ö–æ–¥: CODE-7466)
2025-05-09 20:25:18,302 - INFO - –°–º–µ–Ω–∞ –Ω–∞—á–∞—Ç–∞ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ 10
